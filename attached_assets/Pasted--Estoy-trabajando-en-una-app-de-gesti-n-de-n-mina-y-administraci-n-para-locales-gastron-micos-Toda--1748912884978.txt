
Estoy trabajando en una app de gesti√≥n de n√≥mina y administraci√≥n para locales gastron√≥micos. Toda la l√≥gica y sistema est√°n cargados en este mismo proyecto de Replit.

Quiero que me ayudes a revisar, corregir y reestructurar completamente (si es necesario) la l√≥gica de la secci√≥n N√≥minas, incluyendo:

üîπ Generaci√≥n de n√≥minas  
üîπ Regeneraci√≥n de n√≥minas  
üîπ C√°lculo de pagos a empleados activos y liquidaciones  
(Los empleados activos aparecen como active o inactive en la columna status de la tabla employees.  
Si est√°n "active", se les deber√≠a generar la n√≥mina cuando se lo pide a trav√©s del bot√≥n "Generar N√≥mina".  
Si est√°n "inactive", deben tener fecha de egreso y se deber√≠a calcular su liquidaci√≥n con el bot√≥n "Generar Liquidaciones".)

Al generar las n√≥minas de empleados activos, se debe considerar las adiciones o deducciones que surgen desde el registro de asistencias, en la tabla attendance.  
Entre el sueldo en mano, el sueldo en banco, las adiciones, las deducciones y el posible bono por presentismo (si corresponde, seg√∫n l√≥gica ya cargada en el sistema), se calculan los sueldos de empleados activos a pagar a principios de cada mes.  
Toda esta l√≥gica ya est√° plasmada en el sistema actual, pero no est√° de m√°s que revises bajo tu criterio si est√° bien implementada o si encontr√°s errores o formas de mejorar la funcionalidad.

Lo que dej√≥ de funcionar en alg√∫n momento es la generaci√≥n de n√≥minas, que tira diversos errores.  

üîπ Exportaci√≥n a PDF o Excel  
üîπ Confirmaci√≥n de pagos y guardado en historial  
(Cuando se confirma el pago en mano y el pago en banco tambi√©n, se pasa el valor del pago total al historial de pagos.  
Deber√≠amos tener la opci√≥n de exportaci√≥n a PDF con todos los datos completos del mismo).

---

## üß† CONTEXTO FUNCIONAL

La secci√≥n de n√≥minas trabaja as√≠:
1. Debe detectar todos los empleados activos (desde la tabla employees).
2. Sobre esos empleados, genera una n√≥mina mensual, que incluye:
   - Sueldo base (sueldo en banco + sueldo en mano)
   - Deducciones por llegadas tarde o faltas (vienen de asistencias)
   - Adiciones por feriados trabajados (tambi√©n desde asistencias)

Tanto las deducciones como las adiciones deben descontar o sumar dinero en base al valor del minuto estipulado en la l√≥gica actual, y aplicarse √∫nicamente sobre el valor de sueldo en mano.  
Esto dar√° como resultado el valor de sueldo en mano final (final_hand_salary en la tabla payroll).  
Resultado final: sueldo total a pagar (dividido en banco y en mano).

3. Luego, el usuario puede confirmar el pago (por banco, mano o ambos).
4. Eso deber√≠a quedar reflejado como pago confirmado en la tabla de historial.
5. Todo debe poder ser exportado con detalle por mes.

---

## ‚öôÔ∏è ARCHIVOS INVOLUCRADOS (o posiblemente conectados)

No conozco todos los archivos exactos que est√°n vinculados a esta secci√≥n, pero deber√≠an estar en estas rutas y estructuras del proyecto:

- lib/payroll-service.ts ‚Üí L√≥gica principal para generar las n√≥minas  
- lib/db/db-payroll.ts ‚Üí Base de datos Supabase (query a empleados, n√≥minas, etc.)  
- lib/db/db-core.ts  
- lib/types.ts ‚Üí Tipos definidos para empleados, pagos, n√≥minas  
- pages/n√≥mina.tsx ‚Üí Vista o interfaz principal de n√≥minas  
- Cualquier middleware, API route (pages/api/) o hook relacionado a payroll  
- Puede haber otros archivos involucrados que yo desconozca  

Necesito que detectes todos los archivos relacionados directa o indirectamente, aunque yo no los haya mencionado. Pueden haber componentes o funciones duplicadas, mal llamados o con l√≥gica desactualizada.

‚ö†Ô∏è En este caso necesito enfocarme en la parte de n√≥minas activas y no en liquidaciones. Eso lo haremos como segundo paso.

---

## ‚ùå ERRORES ACTUALES

1. El bot√≥n "Generar N√≥mina" no hace nada actualmente (no da feedback ni error).
2. Tampoco funciona "Regenerar N√≥mina", que deber√≠a eliminar la anterior del mes y rehacerla.
3. Ya no s√© qu√© funciona y qu√© no, porque probablemente los √∫ltimos cambios hayan desincronizado algunas l√≥gicas.
4. Es probable que ahora tambi√©n est√© fallando el bot√≥n de "Confirmar Pago", y que no se est√©n guardando los pagos en la tabla de historial.
5. En algunos momentos aparec√≠an errores como `console.log(...) is not a function`, otros de Supabase (por claves no definidas), y errores silenciosos en el navegador sin informaci√≥n en la consola visible desde Preview.

---

## ‚úÖ LO QUE NECESITO

Quiero que:
- Analices profundamente toda la l√≥gica y los archivos vinculados a n√≥minas.
- Corrijas cualquier error actual, especialmente los que impiden generar o confirmar n√≥minas.
- Verifiques que:
   - Se toman los empleados activos correctamente  
   - Se traen correctamente los datos de asistencias  
   - Se hacen bien los c√°lculos de sueldo  
   - Se graban correctamente los datos en la base de datos  
   - Se puede confirmar el pago  
   - Se genera un historial de pagos  
   - Todo se puede exportar correctamente

Adem√°s, indicame c√≥mo puedo probar correctamente cada cosa (d√≥nde ver errores, consola, etc.).

Por √∫ltimo, si encontr√°s archivos duplicados, inconsistencias en nombres de variables, uso incorrecto de tipos o estructuras que puedan causar errores a futuro, avisame as√≠ los ordenamos bien.

---

## üìù Aclaraciones finales

- Ya est√°n cargadas las claves de Supabase en los Secrets.
- Estoy usando el sistema desde dos computadoras distintas (oficina y casa) pero todo est√° centralizado en Replit, no edito desde GitHub ni localmente.
- Pod√©s usar la consola, el entorno de ejecuci√≥n o cualquier herramienta interna para detectar errores y probar.
- Ten√© libertad de reestructurar lo que creas necesario siempre que no rompa otras secciones del sistema, como empleados, asistencias u home.
